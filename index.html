<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pac-Mario: Final System</title>
<style>
    /* RESET & LAYOUT */
    :root { --neon: #00ffcc; --bg: #050505; }
    body { background: var(--bg); margin: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: monospace; user-select: none; touch-action: none; }
    
    #game-shell { 
        position: relative; width: 100%; max-width: 500px; height: 100%; max-height: 800px; 
        background: #000; border: 4px solid #333; display: flex; flex-direction: column; overflow: hidden; 
    }
    
    canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

    /* UI ELEMENTS */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; background: rgba(0,0,0,0.95); }
    .hidden { display: none !important; }

    #hud { 
        position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; 
        display: flex; justify-content: space-between; font-size: 18px; color: #fff; font-weight: bold; pointer-events: none; z-index: 10;
        text-shadow: 2px 2px 0 #000;
    }
    .val { color: #ffd700; }

    h1 { color: #fff; text-shadow: 4px 4px 0 #b00; margin: 0 0 20px 0; text-align: center; }
    
    button { 
        background: #e60012; color: #fff; border: 4px solid #fff; padding: 20px; 
        font-family: inherit; font-size: 16px; font-weight: bold; cursor: pointer; 
        box-shadow: 0 6px 0 #800; text-transform: uppercase;
    }
    button:active { transform: translateY(4px); box-shadow: 0 2px 0 #800; }

    /* CONTROLS */
    #touch { display: none; z-index: 15; position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    .zone { position: absolute; pointer-events: auto; border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; }
    #pad-zone { bottom: 20px; left: 20px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); }
    #btn-zone { bottom: 40px; right: 20px; width: 90px; height: 90px; background: rgba(255,0,0,0.2); }
</style>
</head>
<body>

<div id="game-shell">
    <canvas id="cvs"></canvas>
    
    <div id="hud">
        <div>SCORE <span id="score" class="val">0</span></div>
        <div>LIVES <span id="lives" class="val">3</span></div>
    </div>
    
    <!-- START MENU -->
    <div id="menu" class="overlay">
        <h1>PAC-MARIO<br>FINAL</h1>
        <button id="start-btn">INITIALIZE SYSTEM</button>
    </div>
    
    <!-- GAME OVER -->
    <div id="gameover" class="overlay hidden">
        <h1>GAME OVER</h1>
        <button id="restart-btn">TRY AGAIN</button>
    </div>

    <!-- MOBILE CONTROLS -->
    <div id="touch">
        <div id="pad-zone" class="zone"></div>
        <div id="btn-zone" class="zone"></div>
    </div>
</div>

<script>
// --- ENGINE CORE ---
const GAME = {
    active: false,
    mode: 'MAZE',
    level: 1,
    score: 0,
    lives: 3,
    ctx: null,
    w: 0, h: 0,
    keys: { u:0, d:0, l:0, r:0, a:0 },
    cam: 0,
    entities: [],
    powerMode: false,
    powerTimer: 0,
    audioCtx: null,
    bgmInt: null
};

// --- CONFIG ---
const CFG = {
    TILE: 32,
    GRAVITY: 0.7,
    SPEED_MAZE: 4,
    SPEED_PLAT: 0.6,
    MAX_SPEED: 6,
    JUMP: -15,
    FRICTION: 0.85
};

// --- ASSET GENERATOR ---
const GFX = {};
function genSprite(key, w, h, fn) {
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    fn(c.getContext('2d'), w, h);
    GFX[key] = c;
}

function initAssets() {
    // Mario
    genSprite('mario', 32, 32, (c) => {
        c.fillStyle='#d00'; c.fillRect(6,4,20,8); c.fillRect(14,2,12,4); // Hat
        c.fillStyle='#fca'; c.beginPath(); c.arc(16,16,10,0,Math.PI*2); c.fill(); // Face
        c.fillStyle='#000'; c.fillRect(18,18,6,2); // Moustache
        c.fillStyle='#d00'; c.beginPath(); c.arc(16,28,8,0,Math.PI*2); c.fill(); // Body
    });
    // Big Mario
    genSprite('mario_big', 32, 64, (c) => {
        c.fillStyle='#f00'; c.fillRect(6,20,20,40); 
        c.fillStyle='#00d'; c.fillRect(6,40,20,20);
        c.fillStyle='#fca'; c.beginPath(); c.arc(16,16,14,0,Math.PI*2); c.fill();
        c.fillStyle='#d00'; c.fillRect(2,4,28,10); c.fillRect(14,0,16,6);
    });
    // Ghost
    genSprite('ghost', 32, 32, (c) => {
        c.fillStyle='#f0f'; c.beginPath(); c.arc(16,14,12,Math.PI,0); c.lineTo(28,28); c.lineTo(4,28); c.fill();
        c.fillStyle='#fff'; c.beginPath(); c.arc(12,12,4,0,Math.PI*2); c.arc(20,12,4,0,Math.PI*2); c.fill();
        c.fillStyle='#000'; c.beginPath(); c.arc(13,12,2,0,Math.PI*2); c.arc(21,12,2,0,Math.PI*2); c.fill();
    });
    // Scared Ghost
    genSprite('ghost_scared', 32, 32, (c) => {
        c.fillStyle='#00f'; c.beginPath(); c.arc(16,14,12,Math.PI,0); c.lineTo(28,28); c.lineTo(4,28); c.fill();
        c.fillStyle='#fea'; c.fillRect(10,12,4,4); c.fillRect(18,12,4,4); c.fillRect(10,20,12,2);
    });
    // Pipe
    genSprite('pipe', 32, 32, (c) => {
        c.fillStyle='#0a0'; c.fillRect(2,2,28,28); c.strokeStyle='#0f0'; c.lineWidth=2; c.strokeRect(4,4,24,24);
    });
    // Wall
    genSprite('wall', 32, 32, (c) => {
        c.fillStyle='#b50'; c.fillRect(0,0,32,32); c.strokeRect(0,0,32,32);
    });
    // Coin
    genSprite('coin', 16, 16, (c) => {
        c.fillStyle='#ff0'; c.beginPath(); c.arc(8,8,4,0,Math.PI*2); c.fill();
    });
    // Pellet
    genSprite('pellet', 24, 24, (c) => {
        c.fillStyle='#ffb'; c.beginPath(); c.arc(12,12,8,0,Math.PI*2); c.fill();
    });
    // Key
    genSprite('key', 32, 32, (c) => {
        c.fillStyle='#ff0'; c.font='20px sans-serif'; c.fillText('ðŸ”‘',6,24);
    });
    // Mushroom
    genSprite('mushroom', 32, 32, (c) => {
        c.fillStyle='#fff'; c.beginPath(); c.arc(16,22,10,0,Math.PI*2); c.fill();
        c.fillStyle='#d00'; c.beginPath(); c.arc(16,16,14,Math.PI,0); c.fill();
    });
}

// --- AUDIO ---
function initAudio() {
    try {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        GAME.audioCtx = new AudioContext();
    } catch(e) { console.log('Audio not supported'); }
}

function playSfx(type) {
    if(!GAME.audioCtx) return;
    const ctx = GAME.audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    const t = ctx.currentTime;
    
    if(type=='coin') {
        o.type='square'; o.frequency.setValueAtTime(900,t); o.frequency.exponentialRampToValueAtTime(1800, t+0.1);
        g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0, t+0.1);
        o.start(t); o.stop(t+0.1);
    } else if(type=='jump') {
        o.type='square'; o.frequency.setValueAtTime(150,t); o.frequency.linearRampToValueAtTime(300, t+0.2);
        g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0, t+0.2);
        o.start(t); o.stop(t+0.2);
    }
}

function startMusic() {
    if(GAME.bgmInt) clearInterval(GAME.bgmInt);
    let beat = 0;
    GAME.bgmInt = setInterval(() => {
        if(!GAME.active || !GAME.audioCtx) return;
        if(GAME.mode === 'MAZE') {
            const ctx = GAME.audioCtx;
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            const t = ctx.currentTime;
            o.frequency.setValueAtTime(beat%2==0 ? 200 : 300, t);
            g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t+0.1);
            o.start(t); o.stop(t+0.1);
            beat++;
        }
    }, 400);
}

// --- LEVEL ---
function spawn(x, y, type, props={}) {
    const e = { type, x, y, w:32, h:32, vx:0, vy:0, ...props };
    if(type=='COIN') { e.w=16; e.h=16; }
    if(type=='PLAYER') { e.w=24; e.h=24; e.big=false; e.iframes=0; }
    GAME.entities.push(e);
}

function loadLevel() {
    GAME.entities = [];
    const W=15, H=20;
    
    if(GAME.mode === 'MAZE') {
        const grid = [];
        for(let y=0; y<H; y++) {
            const row = [];
            for(let x=0; x<W; x++) {
                let w = (x==0||x==W-1||y==0||y==H-1) || (x%2==0 && y%2==0);
                if(x>5 && x<9 && y>8 && y<13) w=false;
                row.push(w?1:0);
                if(w) spawn(x*32, y*32, 'WALL');
            }
            grid.push(row);
        }
        
        // Populate
        for(let y=1; y<H-1; y++) {
            for(let x=1; x<W-1; x++) {
                if(grid[y][x]==0) {
                    if((x==1&&y==1)||(x==W-2&&y==1)||(x==1&&y==H-2)||(x==W-2&&y==H-2)) spawn(x*32+4,y*32+4,'PELLET');
                    else if(Math.random()>0.3) spawn(x*32+8,y*32+8,'COIN');
                }
            }
        }
        
        spawn(7*32, 15*32, 'PLAYER');
        spawn(7*32, 3*32, 'KEY');
        spawn(7*32, 10*32, 'PIPE', {locked:true});
        spawn(2*32, 2*32, 'GHOST', {vx:2});
        spawn(12*32, 2*32, 'GHOST', {vx:-2});
        
    } else { // PLATFORM
        spawn(100, 200, 'PLAYER');
        let cx = 0;
        for(let i=0; i<40; i++) {
            let gap = (i>0 && i%5==0) ? 3 : 0;
            let h = 14; if(Math.random()>0.7) h=11;
            cx += gap;
            spawn(cx*32, h*32, 'WALL');
            spawn((cx+1)*32, h*32, 'WALL');
            if(i%7==0 && i>0) spawn(cx*32, (h-4)*32, 'MUSHROOM');
            cx+=2;
        }
        spawn((cx+2)*32, 11*32, 'FLAG');
        spawn(-100, 200, 'GHOST', {ai:'CHASE'});
        spawn(-300, 200, 'GHOST', {ai:'CHASE'});
    }
}

// --- UPDATE ---
function update() {
    if(!GAME.active) return;
    
    const p = GAME.entities.find(e => e.type=='PLAYER');
    if(!p) return;

    if(GAME.powerTimer>0) GAME.powerTimer--;
    else GAME.powerMode = false;
    if(p.iframes>0) p.iframes--;

    // CONTROLS
    if(GAME.mode === 'MAZE') {
        const S = CFG.SPEED_MAZE;
        if(GAME.keys.u) { p.vy=-S; p.vx=0; }
        else if(GAME.keys.d) { p.vy=S; p.vx=0; }
        else if(GAME.keys.l) { p.vx=-S; p.vy=0; }
        else if(GAME.keys.r) { p.vx=S; p.vy=0; }
        
        if(p.vx!=0) p.y = Math.round(p.y/32)*32 + 4;
        if(p.vy!=0) p.x = Math.round(p.x/32)*32 + 4;
    } else {
        if(GAME.keys.l) p.vx -= CFG.SPEED_PLAT;
        if(GAME.keys.r) p.vx += CFG.SPEED_PLAT;
        p.vx = Math.max(-CFG.MAX_SPEED, Math.min(CFG.MAX_SPEED, p.vx));
        p.vx *= CFG.FRICTION;
        p.vy += CFG.GRAVITY;
        
        if(GAME.keys.a && p.grounded) { p.vy=CFG.JUMP; p.grounded=false; playSfx('jump'); }
        GAME.cam += (p.x - 200 - GAME.cam) * 0.1;
        if(p.y > 800) die();
    }

    // ENTITIES
    GAME.entities.forEach(e => {
        if(e.type=='WALL' || e.type=='FLAG') return;
        
        e.x += e.vx; checkCol(e, 'x');
        e.y += e.vy; checkCol(e, 'y');
        
        if(e.type=='GHOST') {
            if(e.ai=='CHASE') {
                const s = GAME.powerMode ? 1 : 2.5;
                e.x += (p.x>e.x ? s : -s);
                e.y += (p.y>e.y ? s*0.5 : -s*0.5);
            } else if(e.vx==0 && e.vy==0) {
                if(Math.random()>0.5) e.vx=Math.random()>0.5?2:-2; else e.vy=Math.random()>0.5?2:-2;
            }
        }
        
        if(e!==p && intersect(p, e)) {
            if(e.type=='COIN') { e.dead=true; GAME.score+=10; playSfx('coin'); }
            else if(e.type=='PELLET') { e.dead=true; GAME.powerMode=true; GAME.powerTimer=300; }
            else if(e.type=='KEY') { e.dead=true; GAME.entities.find(x=>x.type=='PIPE').locked=false; }
            else if(e.type=='MUSHROOM') { e.dead=true; p.big=true; p.y-=32; GAME.score+=1000; }
            else if(e.type=='PIPE' && !e.locked) { GAME.mode='PLATFORM'; loadLevel(); }
            else if(e.type=='FLAG') { GAME.level++; GAME.mode='MAZE'; loadLevel(); }
            else if(e.type=='GHOST') {
                if(p.iframes>0) return;
                if(GAME.powerMode) { e.dead=true; GAME.score+=200; }
                else if(p.big) { p.big=false; p.iframes=120; p.vx=-p.vx*2; p.vy=-5; }
                else die();
            }
        }
    });
    
    GAME.entities = GAME.entities.filter(e => !e.dead);
    document.getElementById('score').innerText = GAME.score;
    document.getElementById('lives').innerText = GAME.lives;
}

function checkCol(e, axis) {
    if(e.ai=='CHASE') return;
    const walls = GAME.entities.filter(w=>w.type=='WALL');
    e.grounded = false;
    for(let w of walls) {
        if(intersect(e, w)) {
            if(axis=='x') {
                if(e.vx>0) e.x = w.x - e.w; else if(e.vx<0) e.x = w.x + w.w;
                e.vx=0;
            } else {
                if(e.vy>0) { e.y = w.y - e.h; e.grounded=true; } else if(e.vy<0) e.y = w.y + w.h;
                e.vy=0;
            }
        }
    }
}

function intersect(a, b) {
    let ah = a.big ? 64 : a.h;
    return (a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+ah > b.y);
}

function die() {
    GAME.lives--;
    if(GAME.lives < 0) {
        GAME.active = false;
        document.getElementById('gameover').classList.remove('hidden');
    } else {
        loadLevel();
    }
}

// --- RENDER ---
function draw() {
    const ctx = GAME.ctx;
    const cvs = ctx.canvas;
    
    // Auto-Resize
    const box = cvs.parentElement.getBoundingClientRect();
    if(cvs.width !== box.width) { cvs.width = box.width; cvs.height = box.height; }
    
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
    
    ctx.save();
    const scale = cvs.width / (15*32);
    ctx.scale(scale, scale);
    if(GAME.mode=='PLATFORM') ctx.translate(-GAME.cam, 0);
    
    GAME.entities.forEach(e => {
        let img = null;
        if(e.type=='PLAYER') img = e.big ? GFX.mario_big : GFX.mario;
        else if(e.type=='GHOST') img = GAME.powerMode ? GFX.ghost_scared : GFX.ghost;
        else if(e.type=='WALL') img = GFX.wall;
        else if(e.type=='COIN') img = GFX.coin;
        else if(e.type=='PELLET') img = (Date.now()%200<100) ? GFX.pellet : null;
        else if(e.type=='KEY') img = GFX.key;
        else if(e.type=='MUSHROOM') img = GFX.mushroom;
        else if(e.type=='PIPE') { img = GFX.pipe; if(e.locked) ctx.globalAlpha=0.5; }
        else if(e.type=='FLAG') { ctx.fillStyle='#0f0'; ctx.fillRect(e.x,e.y-64,4,96); }
        
        if(img) ctx.drawImage(img, e.x, e.y);
        ctx.globalAlpha=1.0;
    });
    
    ctx.restore();
    requestAnimationFrame(loop);
}

function loop() {
    update();
    draw();
}

// --- SETUP ---
// Wait for DOM
document.addEventListener('DOMContentLoaded', () => {
    const cvs = document.getElementById('cvs');
    GAME.ctx = cvs.getContext('2d');
    
    // Init inputs immediately
    window.addEventListener('keydown', e => k(e.code, 1));
    window.addEventListener('keyup', e => k(e.code, 0));
    function k(c, v) {
        if(c.includes('Up')||c=='KeyW') GAME.keys.u=v;
        if(c.includes('Down')||c=='KeyS') GAME.keys.d=v;
        if(c.includes('Left')||c=='KeyA') GAME.keys.l=v;
        if(c.includes('Right')||c=='KeyD') GAME.keys.r=v;
        if(c=='Space'||c=='Enter') GAME.keys.a=v;
    }
    
    // Touch
    if('ontouchstart' in window) {
        document.getElementById('touch').style.display='block';
        const p = document.getElementById('pad-zone');
        p.ontouchstart = p.ontouchmove = e => {
            e.preventDefault();
            const r = p.getBoundingClientRect(), t=e.touches[0];
            const dx = t.clientX-(r.left+r.width/2), dy = t.clientY-(r.top+r.height/2);
            if(Math.abs(dx)>Math.abs(dy)) { GAME.keys.l=dx<0?1:0; GAME.keys.r=dx>0?1:0; GAME.keys.u=GAME.keys.d=0; }
            else { GAME.keys.u=dy<0?1:0; GAME.keys.d=dy>0?1:0; GAME.keys.l=GAME.keys.r=0; }
        };
        p.ontouchend = () => GAME.keys.u=GAME.keys.d=GAME.keys.l=GAME.keys.r=0;
        const b = document.getElementById('btn-zone');
        b.ontouchstart = e => { e.preventDefault(); GAME.keys.a=1; };
        b.ontouchend = e => { e.preventDefault(); GAME.keys.a=0; };
    }
    
    // Generate Assets
    initAssets();
    
    // Start Button Logic
    document.getElementById('start-btn').onclick = () => {
        initAudio();
        document.getElementById('menu').classList.add('hidden');
        GAME.active = true;
        loadLevel();
        startMusic();
        loop();
    };

    document.getElementById('restart-btn').onclick = () => {
        document.getElementById('gameover').classList.add('hidden');
        GAME.score = 0; GAME.lives = 3; GAME.level = 1; GAME.mode = 'MAZE';
        GAME.active = true;
        loadLevel();
        loop();
    };
});
</script>
</body>
</html>
